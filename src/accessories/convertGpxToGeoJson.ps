# Set input and output folders
$inputFolder = ".\public\gpx"
$outputFolder = ".\public\geojson"
$manifestFile = Join-Path $outputFolder "geojson-list.json"

# Ensure output folder exists
New-Item -ItemType Directory -Force -Path $outputFolder | Out-Null

# Initialize array for manifest filenames
$geojsonFiles = @()

# Get clean UTF-8 encoding without BOM
$utf8NoBom = [System.Text.UTF8Encoding]::new($false)

# Loop over GPX files
Get-ChildItem -Path $inputFolder -Filter *.gpx | ForEach-Object {
    $inputFile = $_.FullName
    $outputFileName = $_.BaseName + ".geojson"
    $outputFile = Join-Path $outputFolder $outputFileName

    if (-Not (Test-Path $outputFile)) {
        try {
            # Load the GPX file as XML
            [xml]$gpxXml = Get-Content -Path $inputFile

            # Check if any <trkseg> elements have <trkpt> children
            $trksegElements = $gpxXml.gpx.trk.trkseg
            $validTrack = $false

            foreach ($trkseg in $trksegElements) {
                if ($trkseg.trkpt.Count -gt 0) {
                    $validTrack = $true
                    break
                }
            }

            # Proceed only if we have valid track points
            if ($validTrack) {
                $geojsonContent = & togeojson $inputFile | Out-String
                if ($geojsonContent.Trim().Length -gt 0) {
                    [System.IO.File]::WriteAllText($outputFile, $geojsonContent, $utf8NoBom)
                    Write-Host "‚úÖ Converted: $($_.Name)"
                } else {
                    Write-Host "‚ö†Ô∏è Empty output for: $($_.Name)"
                }
            } else {
                Write-Host "‚ö†Ô∏è No track points in: $($_.Name), skipped"
            }
        } catch {
            Write-Host "‚ùå Error converting $($_.Name): $_"
        }
    } else {
        Write-Host "‚è≠Ô∏è Skipped (exists): $outputFileName"
    }

    $geojsonFiles += $outputFileName
}

# Write manifest JSON (also without BOM)
try {
    $manifestJson = $geojsonFiles | ConvertTo-Json -Depth 3
    [System.IO.File]::WriteAllText($manifestFile, $manifestJson, $utf8NoBom)
    Write-Host "üìÑ Manifest created at: $manifestFile"
} catch {
    Write-Host "‚ùå Error writing manifest: $_"
}
